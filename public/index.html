<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mnemo ‚Äî Memory Browser</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 2rem;
      border-bottom: 1px solid #2a2a3e;
    }
    
    .header h1 {
      font-size: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .header p {
      color: #888;
      margin-top: 0.5rem;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: #151520;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #2a2a3e;
    }
    
    .stat-card h3 {
      color: #888;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-top: 0.5rem;
    }
    
    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    select, input {
      background: #151520;
      border: 1px solid #2a2a3e;
      color: #e0e0e0;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    input {
      flex: 1;
      min-width: 200px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    .memories {
      display: grid;
      gap: 1rem;
    }
    
    .memory {
      background: #151520;
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 1.5rem;
      transition: border-color 0.2s;
    }
    
    .memory:hover {
      border-color: #667eea;
    }
    
    .memory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .memory-type {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .type-insight { background: rgba(102, 126, 234, 0.2); color: #667eea; }
    .type-preference { background: rgba(118, 75, 162, 0.2); color: #a855f7; }
    .type-goal { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .type-milestone { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .type-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .type-security { background: rgba(220, 38, 38, 0.2); color: #dc2626; }
    .type-decision { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    
    .memory-importance {
      display: flex;
      gap: 0.25rem;
    }
    
    .importance-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2a2a3e;
    }
    
    .importance-dot.active {
      background: #667eea;
    }
    
    .memory-content {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #e0e0e0;
    }
    
    .memory-meta {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      font-size: 0.875rem;
      color: #666;
    }
    
    .empty {
      text-align: center;
      padding: 4rem;
      color: #666;
    }
    
    .loading {
      text-align: center;
      padding: 4rem;
      color: #667eea;
    }
    
    .project-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: #1a1a2e;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
    }
    
    .timeline-date {
      color: #888;
      font-size: 0.875rem;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #2a2a3e;
    }
    
    .suggestions {
      background: #151520;
      border: 1px solid #2a2a3e;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .suggestions h3 {
      color: #667eea;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    .keyword-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .keyword-tag {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }
    
    .keyword-tag:hover {
      background: rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }
    
    .mode-indicator {
      color: #888;
      font-size: 0.875rem;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: #151520;
      border-radius: 8px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>üß† Mnemo</h1>
      <p>Agent Memory Browser ‚Äî Data Lake Edition</p>
    </div>
  </div>
  
  <div class="container">
    <div class="stats" id="stats">
      <div class="stat-card">
        <h3>Total Memories</h3>
        <div class="value" id="totalMemories">-</div>
      </div>
      <div class="stat-card">
        <h3>Projects</h3>
        <div class="value" id="totalProjects">-</div>
      </div>
      <div class="stat-card">
        <h3>This Week</h3>
        <div class="value" id="thisWeek">-</div>
      </div>
      <div class="stat-card">
        <h3>Data Size</h3>
        <div class="value" id="dataSize">-</div>
      </div>
    </div>
    
    <div class="controls">
      <select id="projectSelect">
        <option value="">All Projects</option>
      </select>
      <select id="typeFilter">
        <option value="">All Types</option>
        <option value="insight">Insight</option>
        <option value="preference">Preference</option>
        <option value="goal">Goal</option>
        <option value="milestone">Milestone</option>
        <option value="decision">Decision</option>
        <option value="error">Error</option>
        <option value="security">Security</option>
      </select>
      <input type="text" id="searchInput" placeholder="Search memories...">
      <button onclick="searchMemories()">Search</button>
      <button onclick="loadRecent()">Browse Recent</button>
      <button onclick="showKeywords()">Keywords</button>
      <button onclick="loadTimeline()">Timeline</button>
    </div>
    
    <div class="suggestions" id="suggestions" style="display:none;">
      <h3>üí° Suggested Keywords</h3>
      <div class="keyword-cloud" id="keywordCloud"></div>
    </div>
    
    <div class="memories" id="memories">
      <div class="loading">Loading memories...</div>
    </div>
  </div>
  
  <script>
    let currentProject = '';
    
    async function init() {
      await loadStats();
      await loadProjects();
      await loadMemories();
    }
    
    async function loadStats() {
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        document.getElementById('totalProjects').textContent = data.totalProjects || 0;
        
        // Count total memories across projects
        let total = 0;
        for (const project of data.projects) {
          const count = await fetch(`/api/memory/query?q=*&project=${project}&limit=1`)
            .then(r => r.json())
            .then(d => d.count || 0)
            .catch(() => 0);
          total += count;
        }
        document.getElementById('totalMemories').textContent = total;
        
        // This week (simplified)
        document.getElementById('thisWeek').textContent = '-';
        
        // Data size estimate
        const sizeKB = (data.totalProjects || 0) * 28;
        document.getElementById('dataSize').textContent = sizeKB < 1024 ? `${sizeKB}KB` : `${(sizeKB/1024).toFixed(1)}MB`;
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }
    
    async function loadProjects() {
      try {
        const response = await fetch('/api/projects');
        const data = await response.json();
        
        const select = document.getElementById('projectSelect');
        select.innerHTML = '<option value="">All Projects</option>';
        
        for (const project of data.projects) {
          const option = document.createElement('option');
          option.value = project;
          option.textContent = project;
          select.appendChild(option);
        }
        
        select.addEventListener('change', (e) => {
          currentProject = e.target.value;
          loadMemories();
        });
      } catch (err) {
        console.error('Failed to load projects:', err);
      }
    }
    
    async function loadMemories() {
      await loadRecent();
    }
    
    async function loadRecent() {
      hideSuggestions();
      const container = document.getElementById('memories');
      const typeFilter = document.getElementById('typeFilter').value;
      container.innerHTML = '<div class="loading">Loading recent memories...</div>';
      
      try {
        const project = currentProject || 'general';
        let url = `/api/memory/recent?project=${project}&limit=50&days=365`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        let results = data.results || [];
        
        // Apply type filter if selected
        if (typeFilter) {
          results = results.filter(m => m.content_type === typeFilter);
        }
        
        // Show mode indicator
        const typeLabel = typeFilter ? ` (${typeFilter})` : '';
        container.innerHTML = `<div class="mode-indicator">üìã Browse Mode: ${results.length} memories${typeLabel}</div>`;
        
        renderMemories(results, container);
      } catch (err) {
        container.innerHTML = '<div class="empty">Failed to load memories</div>';
      }
    }
    
    async function showKeywords() {
      const suggestionsDiv = document.getElementById('suggestions');
      const keywordCloud = document.getElementById('keywordCloud');
      
      if (suggestionsDiv.style.display === 'block') {
        hideSuggestions();
        return;
      }
      
      keywordCloud.innerHTML = '<div class="loading">Loading keywords...</div>';
      suggestionsDiv.style.display = 'block';
      
      try {
        const project = currentProject || 'general';
        const response = await fetch(`/api/memory/keywords?project=${project}&limit=30`);
        const data = await response.json();
        
        if (!data.keywords || !data.keywords.length) {
          keywordCloud.innerHTML = '<div class="empty">No keywords found</div>';
          return;
        }
        
        keywordCloud.innerHTML = data.keywords.map(k => 
          `<span class="keyword-tag" onclick="searchKeyword('${k.word}')">${k.word} (${k.count})</span>`
        ).join('');
      } catch (err) {
        keywordCloud.innerHTML = '<div class="empty">Failed to load keywords</div>';
      }
    }
    
    function hideSuggestions() {
      document.getElementById('suggestions').style.display = 'none';
    }
    
    function searchKeyword(keyword) {
      document.getElementById('searchInput').value = keyword;
      hideSuggestions();
      searchMemories();
    }
    
    async function searchMemories() {
      hideSuggestions();
      const query = document.getElementById('searchInput').value;
      if (!query) return;
      
      const container = document.getElementById('memories');
      const typeFilter = document.getElementById('typeFilter').value;
      container.innerHTML = '<div class="loading">Searching...</div>';
      
      try {
        let url;
        if (currentProject) {
          url = `/api/memory/query?q=${encodeURIComponent(query)}&project=${currentProject}&limit=20`;
          if (typeFilter) url += `&type=${typeFilter}`;
        } else {
          url = `/api/memory/query-all?q=${encodeURIComponent(query)}&limit=20`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        let results = data.results || [];
        
        // Apply type filter for query-all (since it doesn't support type param)
        if (!currentProject && typeFilter) {
          results = results.filter(m => m.content_type === typeFilter);
        }
        
        // Show mode indicator
        const typeLabel = typeFilter ? ` (${typeFilter})` : '';
        container.innerHTML = `<div class="mode-indicator">üîç Search: "${query}" ‚Äî ${results.length} results${typeLabel}</div>`;
        
        renderMemories(results, container);
      } catch (err) {
        container.innerHTML = '<div class="empty">Search failed</div>';
      }
    }
    
    async function loadTimeline() {
      const container = document.getElementById('memories');
      container.innerHTML = '<div class="loading">Loading timeline...</div>';
      
      try {
        const project = currentProject || 'general';
        const response = await fetch(`/api/memory/timeline?project=${project}&days=30`);
        const data = await response.json();
        
        renderTimeline(data.timeline || {});
      } catch (err) {
        container.innerHTML = '<div class="empty">Failed to load timeline</div>';
      }
    }
    
    function renderMemories(memories, container = null) {
      if (!container) {
        container = document.getElementById('memories');
      }
      
      if (!memories.length) {
        container.innerHTML += '<div class="empty">No memories found</div>';
        return;
      }
      
      container.innerHTML += memories.map(m => `
        <div class="memory">
          <div class="memory-header">
            <span class="memory-type type-${m.content_type || 'insight'}">
              ${m.content_type || 'insight'}
            </span>
            <div class="memory-importance">
              ${Array(10).fill(0).map((_, i) => `
                <div class="importance-dot ${i < (m.importance || 5) ? 'active' : ''}"></div>
              `).join('')}
            </div>
          </div>
          <div class="memory-content">${escapeHtml(m.content)}</div>
          <div class="memory-meta">
            <span>üìÅ ${m.project || 'general'}</span>
            <span>üïê ${formatDate(m.created_at)}</span>
            ${m.project !== currentProject ? `<span class="project-badge">${m.project}</span>` : ''}
          </div>
        </div>
      `).join('');
    }
    
    function renderTimeline(timeline) {
      const container = document.getElementById('memories');
      const dates = Object.keys(timeline).sort().reverse();
      
      if (!dates.length) {
        container.innerHTML = '<div class="empty">No memories in timeline</div>';
        return;
      }
      
      container.innerHTML = dates.map(date => `
        <div class="timeline-date">${formatDate(date)}</div>
        ${timeline[date].map(m => `
          <div class="memory">
            <div class="memory-header">
              <span class="memory-type type-${m.content_type || 'insight'}">
                ${m.content_type || 'insight'}
              </span>
              <div class="memory-importance">
                ${Array(10).fill(0).map((_, i) => `
                  <div class="importance-dot ${i < (m.importance || 5) ? 'active' : ''}"></div>
                `).join('')}
              </div>
            </div>
            <div class="memory-content">${escapeHtml(m.content)}</div>
            <div class="memory-meta">
              <span>üìÅ ${m.project || 'general'}</span>
            </div>
          </div>
        `).join('')}
      `).join('');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }
    
    // Search on Enter
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchMemories();
    });
    
    // Init
    init();
  </script>
</body>
</html>